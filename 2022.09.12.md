# TCP基本认识

## 1.TCP的头部字段

```
源端口号（16）                           目的端口号（16）
                    序列号（32）
                  确认应答号（32）
首部长度（4）|保留（6）|URG|ACK|PSH|RST|SYN|窗口大小（16）
校验和（16）                              紧急指针（16）
                   选项（长度可变）
                        数据
```

- 序列号：在建⽴连接时由计算机⽣成的随机数作为其初始值，通过 SYN 包传给接收端主机，每发送⼀次数据，就 「累加」⼀次该「数据字节数」的⼤⼩。⽤来解决⽹络包乱序问题

- 确认应答号：<u>指下⼀次「期望」收到的数据的序列号</u>，发送端收到这个确认应答以后可以认为在这个序号以前的数 据都已经被正常接收。⽤来解决不丢包的问题。

控制位：

- ACK：该位为1，确认应答字段有效，除了初始建立链接时以外其他情况此位必须设置为1
- RST：该位为1，表示TCP链接出现异常必须强制断开连接
- SYN：该位为1表示希望建立TCP连接，并在其序列号中设置初始值
- FIN：该位为1表示希望断开连接

### 1.1为什么需要TCP协议？

因为IP层是不可靠的，其不保证数据包交付、更不保证按序号交付、不保证数据包完整性。在需要确保数据被完整传输时，就需要使用上层的TCP协议。TCP协议层工作在运输层，其能保证接收的网络包是完整、按序、无间隔和非冗余的

### 1.2什么是TCP？

TCP是一种面向连接的、可靠的、基于字节流的运输层协议。

- 面向连接：必须一对一建立链接，不能如UDP那般可一个主机同时向多个主机发送消息
- 可靠性：不论链路出现何种变化，TCP保证一个报文能够传输至接收端
- 字节流：消息无论多大都可进行传输，并且消息时有序的，当前一个消息未被接收时，即使接收端先收到了后面的字节，也不能字节丢给应用层处理，同时对重复的报文会自动丢弃

### 1.3如何唯一确定一个TCP连接

TCP四元组（源端口和IP、目的端口和IP）

- 源端口和目的端口在TCP头部中，用于告知TCP协议应该把报文发送给哪个进程
- 源IP和目的IP在IP头部中，用于通过IP协议向对方主机发送报文

### 1.4一个IP的服务器最大并发连接数？

因为服务器通常都在一个端口上监听因此：

最大理论数目为：客户端IP数 *客户端端口数。分别是2^32和2^16，因此理论最大连接数为2^48.实际上是远远不能达到的。

- 文件描述符有限
- 内存有限，每个SOCKET其实就是控制信息加缓冲区内存构成的，操作系统能够分配的内存是有限的

### 1.5UDP和TCP的区别

UDP不提供类似TCP这样复杂的控制机制，它利用IP提供无连接的通信服务。UDP头部格式非常简单：

```
源端口号（16）|目的端口号（16）
包长度（16）|校验和（16）
```

- 包长度保存UDP首部和数据的长度
- 校验和提供可靠的UDP首部和数据（而称UDP是不可靠协议是因为它不提供确认应答的机制，中途丢包时大有可能的）

区别：

- 连接：TCP需要建立链接，但是UDP不需要
- 服务对象：TCP提供一对一的端到端的服务，而UDP提供一对多服务
- 可靠性：TCP保证传递按序、完整、非冗余的数据，UDP不保证可靠传递数据
- 流量控制：TCP有拥塞控制和流量控制，保证数据安全传输，而UDP即使网络再拥堵也不会影响其发送速率

- 首部开销：TCP首部开销即使没有选项部分时也有20字节，UDP只有8字节
- 传输方式：TCP是流式传输，无边界，但保证顺序和可靠，UDP是一个包一个包地传输，有边界，但是可能丢包和乱序
- 分片不同：TCP如果传输数据的大小大于了MSS，会在运输层分片，目标主机接收到之后也会在运输层进行组装，如果有丢失，那么只需要重传丢失的数据包即可；UDP如果数据大于了MTU，会在IP层分片接收方也在IP层组装，如果有数据丢失，实现可靠UDP时就得重传所有的数据包，效率非常差，因此，一般保证一次传送数据不大于MTU

### 1.6TCP和UDP的应用场景

TCP可靠传输的性质，经常用于：

- FTP文件传输
- http/https

UDP的高效率经常用于：

- 包总量较少的通信，比如DNS，SNMP
- 视频音频
- 广播

### 1.7关于UDP首部包长度的问题

为了计算TCP数据的长度，TCP头部会设立一个头部长度，IP头部会设立IP头部长度，那么TCP数据的总长度就是：

- IP数据包总长度 - IP头部长度 - TCP头部长度

而UDP头部含有一个包长度，但是但是同时UDP头部长度固定不变，不想TCP头部因为添加了可选项，头部长度不确定，因此感觉UDP首部的包长度字段有些多余。据猜测，他的作用可能是为了方便一些网络设备硬件处理数据而专门凑成了4字节的整数倍。