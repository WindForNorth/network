# IP协议相关技术

主要且重要的技术，并非全部：

- DNS域名解析
- ARP和RARP协议
- DHCP动态主机配置协议
- NAT地址转换
- ICMP互联网控制报文协议
- IGMP因特网组管理协议

## 1.DNS域名解析

关于域名层级关系作简要复习：

- 最右面为最顶级的域名，根域是最高级的，但是未在一个完整域名中标识，一般是一个.表示
- 根域的信息（比如IP地址）保存在任何一个DNS服务器中

### 1.1.域名解析的工作流程

首先会查看自己程序的缓存有没有相关域名的IP地址，没有的话就去找操作系统缓存，还没有就找本机域名解析文件hosts，还是没有的话就需要发送DNS查询请求了，其一般流程如下：

- 首先程序和一般通信流程类似将发送报文传递给下层协议栈，不过使用UDP运输层协议
- 经过包装之后的报文会发送至本地DNS服务器（就是网络设置中的那个DNS）
- 如果本地DNS服务器没有找到，它就去向根域服务器查询
- 根域不负责直接查询工作，只是会将域名的定级域名服务器的联系方式返回给本地DNS服务器
- 接着向顶级域名服务器查询，没有找到那么就会返回其下一级的域名的联系方式
- 直至找到域名的权威服务器返回IP地址给本地DNS服务器，本地DNS服务器将查询到的IP地址返回给主机

## 2.ARP和RARP

### 2.1.ARP

ARP协议用于查找对应IP地址的路由器的MAC地址，当进行转发时，当前路由器可以查询路由表知道下一跳路由器的IP地址，但是其数据链路层的MAC地址需要通过ARP广播在同一个子网中查询，收到ARP查询报文的主机或者路由器会确认所属于IP地址是否与自己的相符，如果是那么就发送ARP响应报文，将自己的MAC地址返回

如一般的优化手段，ARP查询结果一般会在缓存中待一段时间，方便短时间内快速查询

### 2.2.RARP

与RAP刚好反过来，是通过MAC地址查询IP地址的协议

通过发送RARP查询报文附上自己的MAC地址，以向服务器求得自己分配的IP地址

## 3.DHCP

主机联网都需要一个IP地址，那么这个IP地址怎么来的呢，就是通过DHCP动态查询，查询一般的四个步骤：

- 由于此时客户没有IP地址，所以发送DHCP发现报文（DHCP DISCOVER）的源IP地址是0.0.0.0，使用的端口是68，目的IP地址是广播地址255.255.255.255，目的端口是67，且使用UDP广播。链路层帧被广播到网络中的所有设备
- DHCP服务器收到发现报文之后，返回DHCP提供报文（DHCP OFFER），仍然使用广播方式，其中携带可租约的IP地址及其租约时间、DNS服务器、子网掩码、默认网关等信息
- 客户端可能会收到多个DHCP服务器的响应，客户端会从中挑选一个合适的，并向其服务器发送DHCP请求报文（DHCP REQUEST），回显配置参数
- 服务器用DHCP ACK报文响应

完成交互之后，客户端就可以在租用期内使用这个IP地址，如果该IP地址使用快到期了，那么就再次向服务器发送请求报文，此时有两种情况：

- 服务器同意继续使用，并返回DHCP ACK报文延长租用期
- 服务器不同意继续使用，那么客户端不能再继续使用这个IP地址，必须另换IP

### 3.1DHCP中继代理

路由器不会转发广播包，那么如果DHCP不在同一个网络，那么上面的过程就无效，但是每个网络下都配置一个DHCP服务器，这是天方夜谭，因此需要有DHCP中继代理

DHCP中继代理一般是路由器来的，它对于DHCP DISCOVER广播报文会进行转发（如果需要的话），要么将这个报文发送给其他DHCP中继代理，要么发送给DHCP服务器（以单播的形式）

DHCP服务器收到这个报文，那么会将应答返回给中继代理，中继代理又会使用广播的方式通知网络下的客户端

## 4.NAT

关于地址转换技术的简要概述：

- 通过一个配置有公网IP的服务器，下辖多个私有IP地址的客户端，建立公有IP地址、端口号和私有IP地址、端口号之间的映射从而实现使用私有地址连接互联网（实际使用还是公有地址）

主要是它的缺陷：

- 只有在建立映射条目之后，互联网才能向客户端发送信息（就是说，互联网没办法主动向具有私有地址的客户端发送信息）
- 进行地址转换需要消耗一定时间
- 一旦地址转换服务器出现问题（比如断电、各种故障），那么已经建立好的连接将会被强制中断

解决方案：

- 使用IPv6：没什么好说的，IPv6的地址多如牛毛，每个设备都配置公有IP完全不在话下
- NAT穿透：网络应用程序自己主动发现自己处于NAT之后，主动向服务器获得公网IP并自己建立映射关系

## 5.ICMP

中文名：互联网控制报文协议

用于：确认 IP 包是否成功送达⽬标地址、报告发送过程中 IP 包被废弃的原因和改善⽹络设置 等

比如：一主机A向主机B发送信息，主机B因为某种原因不能收到路由器发送来的包，那么当主机B方的路由器发送ARP查询报文无果多次之后，便会原路返回一个ICMP报文，通告主机B不可达

### 5.1.ICMP类型

- 一类用于诊断查询，属查询报文类
- 一类用于通知错误原因的错误消息，属差错报文类型

![image-20221008115052680](D:\MySoftware\Typora\typora-user-images\image-20221008115052680.png)

## 6.IGMP

用于管理组播的协议，中文名：因特网组管理协议。控制一组主机能否收到特定的数据包

- 通常情况下，路由器是不会发送组播包到连接中的主机的，只有主机自己主动向路由器发送IGMP信息请求加入或者退出组播组，路由器再决定是否要将组播包发送给对应主机。路由器中有一个IGMP路由表，用于记录加入组播的成员

- IGMP报文使用IP封装、头部协议号为2、TTL通常为1（因为IGMP协议工作在直接连接的路由器和主机之间）

### 6.1.IGMP工作机制

#### 6.1.1.常规查询和响应

- 路由器周期性发送目的地址为表示同一个网段下的所有主机和路由器的IGMP常规查询报文
- 组播成员收到这个报文之后，启动定时器（时间随机），超时后发送一个IGMP成员关系报告报文
- 组播成员在收到其他成员的关系报告之后将不会再发送成员关系报告，减少IGMP包
- 路由器收到关系报告，会在IGMP路由表中加入这个组播组，后续网络中的报文到达该路由器就会被转发给成员

#### 6.1.2.离开组播组

- 当一个主机要退出组播组，向同网段所有路由器（用特定组播地址表示目的地址）发送离组报文
- 路由器收到，以1秒为间隔，连续发送两个特定组得查询报文，用于确认该组是否还有成员
- 如果还有成员，那么成员会响应特定组查询报文，于是路由器知道还有成员会继续向这个组播组转发消息；如果没有成员了，这个特定组查询报文将不会得到任何响应一段时间后，路由器认定已经没有成员在这个组播组，将不会向这个组播组发送消息

PS：组播地址没有主机号和网络号，不能用于主机IP，因此主机IP不会改变，而是否加入和离开某个组，是socket的某API实现的，且组播常用UDP协议，其中目的地址填写的组播地址