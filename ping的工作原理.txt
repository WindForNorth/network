# ping的工作原理

## 1.ICMP协议

判断对端网络是否畅通时使用最多的莫过于ping（Packet Internet Groper 因特网包探测器）

ping是基于ICMP协议工作的，因此想要明白ping的工作原理，那么必须得熟悉ICMP协议

前面已经说过了一些ICMP的内容，此处深入探究下

回顾其主要功能：确认IP包是否成功送达、通告IP包在传输过程中被废弃的原因、改善网络设置

### 1.1.ICMP包头格式

ICMP报文是封装在IP包内，工作与网络层的IP协议的助手。IP头部中有一个字段是协议类型（8位），如果传送的包时ICMP包的话会被设置为1。此处主要说明ICMP头：

- 类型（8）、代码（8）
- 校验和（16）
- 根据类型和代码不同的而不同的数据内容

包头中的类型字段大致可以分为：查询用的查询报文类型、通知出错原因的差错报文类型：

- 0(Echo Reply)回送应答，属于查询报文类型
- 3(Destination Unreachable)目标不可达，属于差错报文类型
- 4(Source Quench)原点抑制，属于差错报文类型
- 5(Redirect)重定向或者改变路由，属于差错报文类型
- 8(Echo Request)回送请求，属于查询报文类型
- 11(Time Exceeded)超时，属于差错报文类型

### 1.2.查询报文类型

分别上述的0和8，判断数据包是否成功送达对端。发送主机发送类型为8的ICMP请求报文，如果对端成功接收返回类型为0的ICMP应答报文，表示接收主机可达

通常ICMP报头还有两个字段：标识符、序号。标识符常用来表示发送ICMP报文的主机进程，序号是每次发送一个新的回送请求就+1，分别用于标识主机的进程和判断网络包是否丢失

### 1.3.差错报文类型

#### 1.3.1.目标不可达（3）

当IP数据包没法送到对端时会向发送方发送一个ICMP类型为3的错误信息，并报告出错的原因，具体原因会写在代码段。不可达只是一个笼统的概念，具体可以分为很多不可达的类型，以下包括主要类型：

- 0（network Unreachable）网络不可达：也就是对端路由器发现在自己的路由表内根本匹配不到目标地址的网络号，此时回送一个网络不可达的消息
- 1（Host Unreachable）主机不可达：也就是对端路由器发现路由表中没有目标主机的信息或者目标主机没有连接网络，此时回送主机不可达信息
- 2（Protocol Unreachable）协议不可达：对端主机禁止该协议的访问，此时回送协议不可达消息
- 3（Port Unreachable）端口不可达，对端根本没有监听目标端口此时回送端口不可达消息
- 4（Fragmentation needed but No frag）需要分片但是设置了不可分片，就是一个包已经大于了MTU，但是包设置了不可分片，没法传送只能丢弃，所以回送类型4的消息

#### 1.3.2.原点抑制（4）

路由器向低速线路发送消息时，遇到拥堵致使队列缓存变为0而无法将数据发送时，会回送一个原点抑制的消息，发送端借此知道网络中某处存在网络拥堵，增大IP数据的发送间隔，减少拥堵。但是这种ICMP消息可能引起不公平的网络信息，一般不被使用

#### 1.3.3.重定向（5）

路由器再持有更加优秀的路由选择时会向发送端主机回送一个重定向的消息，这个消息还包含最合适的路由信息和源数据，告知发送主机，让其下次发送数据发给另一个路由器

#### 1.3.4.超时（11）

当包在网络中传输TTL减为0时，这个包会被丢弃，同时路由器向发送主机发送一个ICMP超时的消息

## 2.查询报文的使用

当主机Aping主机B时，主机A构建一个ICMP回送请求数据包，其中两个比较重要的字段，“类型”被填写为8，还有序号，每次发送一个请求加1；为了能够计算往返时间，会在报文的数据部分加上发送时间；

之后ICMP协议会将这个包连通目的IP地址交给IP层，IP层将“协议类型”字段设置为1，表示ICMP报文，并将目的IP和源IP设置好，构建一个IP数据包；

IP数据包还需添加链路层帧头（比如MAC头部），通过本地读取也好，发送ARP广播查询也好，最终会得到目的IP地址的MAC地址，再以本机MAC地址作为源MAC地址构建链路层帧发送；

经过路由器交换机的通力合作，最后假设这个帧成功到达对端，IP层将ICMP消息给到上层，之后上层同样构建一个ICMP回送应答包，类型为0交给IP层，经过与发送相同的操作之后发送；

在规定时间内若请求端没有收到ICMP应答，则认为对方主机不可达，反之认为可达，还能根据包的接收时间以及自己的发送时间计算出往返时延

## 3.差错报文的使用

一个命令：traceroute（UNIX和MacOS）、Windows叫做（tracert）

作用一：IP发现

将IP数据包的TTL字段从1开始递增，顺序发送UDP包，设置一个不可达的端口（>3000），这样一路上每个返回超时的路由器同时返回其IP地址，而当UDP包到达对端时会返回一个端口不可达的ICMP消息。通过这种不断利用TTL引发超时的方法可以得到整个路径的路由器的IP地址，当然有的路由器实际山并不会返回ICMP消息，也就没办法得知了

作用二：MTU发现

通过设置不允许分片，但是发送大数据包的方式，如果一个路由器端口的MTU小于IP数据包，同时又不能进行分片，那么就会丢弃这个包同时返回ICMP错误信息和自己的MTU；发送端收到这个包，可以不断缩小发送包的大小，以便于找到一个发送数据的合适大小